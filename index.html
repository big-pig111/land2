<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bonk Chatroom</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Luckiest+Guy&family=Roboto:wght@400;700&display=swap" rel="stylesheet">
  <script src="index.iife.min.js"></script>
  <style>
    :root {
      --bonk-orange: #ff9800;
      --bonk-red: #ff3d00;
      --bonk-yellow: #ffe082;
      --bonk-bg: linear-gradient(135deg, #fffbe6 0%, #ffe082 40%, #ff9800 100%);
      --bonk-border: #ffb300;
      --bonk-chat: #fff3e0;
      --bonk-chat-me: #ffe0b2;
      --bonk-shadow: 0 4px 32px rgba(255, 152, 0, 0.18);
      --bonk-font: 'Luckiest Guy', 'Roboto', 'Microsoft YaHei', Arial, sans-serif;
    }
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      font-family: var(--bonk-font);
      min-height: 100vh;
      width: 100vw;
      overflow: hidden;
      /* å¤šå±‚æ¸å˜+å…‰æ–‘ */
      background: var(--bonk-bg),
        radial-gradient(circle at 80% 10%, #fffde7cc 0, #fffde700 60%),
        radial-gradient(circle at 20% 80%, #ffe08299 0, #ffe08200 70%),
        radial-gradient(circle at 60% 60%, #ff980044 0, #ff980000 80%);
      position: relative;
    }
    /* SVGæ³¢æµªèƒŒæ™¯ */
    .bg-waves {
      position: fixed;
      left: 0; right: 0; bottom: 0;
      width: 100vw;
      height: 220px;
      z-index: 0;
      pointer-events: none;
      opacity: 0.7;
    }
    /* å…‰æ–‘åŠ¨ç”» */
    .bg-bubble {
      position: fixed;
      border-radius: 50%;
      pointer-events: none;
      z-index: 0;
      opacity: 0.18;
      animation: float 12s linear infinite alternate;
      filter: blur(2px);
    }
    .bg-bubble1 {
      width: 220px; height: 220px;
      left: 8vw; top: 12vh;
      background: #fffde7;
      animation-delay: 0s;
    }
    .bg-bubble2 {
      width: 160px; height: 160px;
      right: 10vw; top: 30vh;
      background: #ffe082;
      animation-delay: 2s;
    }
    .bg-bubble3 {
      width: 120px; height: 120px;
      left: 20vw; bottom: 18vh;
      background: #ff9800;
      animation-delay: 4s;
    }
    @keyframes float {
      0% { transform: translateY(0) scale(1); }
      100% { transform: translateY(-30px) scale(1.08); }
    }
    /* Bonkç‹—ç‹—æ’ç”»è§’æ ‡ */
    .bg-bonk {
      position: fixed;
      z-index: 1;
      pointer-events: none;
      opacity: 0.92;
      filter: drop-shadow(0 4px 16px #ff980088);
      user-select: none;
    }
    .bg-bonk-right {
      top: 12px;
      right: 12px;
      width: 90px;
    }
    .bg-bonk-left {
      left: 8px;
      bottom: 8px;
      width: 80px;
    }
    /* ä¸»è¦å†…å®¹åŒºz-indexæå‡ */
    .app-container, .username-modal { position: relative; z-index: 2; }
    .app-container {
      display: flex;
      height: 100vh;
      width: 100vw;
      min-width: 320px;
      margin: 0;
      padding: 0;
    }
    .sidebar {
      width: 220px;
      min-width: 180px;
      background: var(--bonk-orange);
      display: flex;
      flex-direction: column;
      align-items: stretch;
      padding: 0;
      box-shadow: 2px 0 16px rgba(255, 152, 0, 0.12);
      z-index: 2;
      position: relative;
      justify-content: space-between;
    }
    .sidebar-content {
      flex: 1;
      display: flex;
      flex-direction: column;
    }
    .sidebar-bottom {
      width: 100%;
      display: flex;
      flex-direction: row;
      align-items: flex-end;
      justify-content: space-around;
      gap: 0;
      padding: 18px 0 12px 0;
      background: transparent;
      min-height: 90px;
    }
    .sidebar-bonk-img {
      width: 48px;
      height: 48px;
      border-radius: 16px;
      box-shadow: 0 2px 12px #ff980088;
      background: #fffde7;
      object-fit: cover;
      transform: rotate(-8deg);
      margin: 0 2px;
      border: 2px solid #fffbe6;
      transition: transform 0.2s;
    }
    .sidebar-bonk-img:nth-child(2) {
      transform: rotate(10deg) scale(1.08);
      z-index: 2;
    }
    .sidebar-bonk-img:nth-child(3) {
      transform: rotate(-14deg) scale(0.95);
      z-index: 1;
    }
    /* ç”¨æˆ·å¤´åƒå±•ç¤º */
    .user-avatar-box {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin: 18px 0 0 0;
      gap: 8px;
    }
    .user-avatar-img {
      width: 64px;
      height: 64px;
      border-radius: 18px;
      box-shadow: 0 2px 12px #ff980088;
      background: #fffde7;
      border: 3px solid #fffbe6;
      object-fit: cover;
      margin-bottom: 4px;
    }
    .user-avatar-name {
      color: #fff;
      font-size: 1.1rem;
      font-family: 'Luckiest Guy', cursive;
      text-shadow: 1px 1px 0 #ff3d00, 0 2px 8px #fffde7;
      letter-spacing: 1px;
      margin-bottom: 2px;
    }
    .logo {
      display: flex;
      align-items: center;
      gap: 14px;
      padding: 32px 24px 24px 24px;
      font-size: 2rem;
      font-family: 'Luckiest Guy', cursive;
      color: #fff;
      letter-spacing: 2px;
      user-select: none;
      text-shadow: 2px 2px 0 #ff3d00, 0 2px 8px #fffde7;
    }
    .logo img {
      width: 48px;
      height: 48px;
      border-radius: 16px;
      background: #fffde7;
      border: 3px solid #fffde7;
      object-fit: cover;
      box-shadow: 0 2px 8px #ff9800;
    }
    .channels {
      display: flex;
      flex-direction: column;
      gap: 12px;
      padding: 0 16px;
      margin-top: 24px;
    }
    .channel {
      padding: 16px 20px;
      border-radius: 14px;
      font-size: 1.2rem;
      font-family: 'Luckiest Guy', cursive;
      font-weight: 500;
      color: #ff3d00;
      background: #fffde7;
      border: 2px solid transparent;
      text-align: left;
      cursor: pointer;
      transition: background 0.2s, color 0.2s, border 0.2s;
      outline: none;
      display: flex;
      align-items: center;
      gap: 10px;
      box-shadow: 0 2px 8px #ffe08244;
    }
    .channel.active, .channel:hover {
      background: var(--bonk-yellow);
      color: #fff;
      border: 2px solid var(--bonk-red);
      box-shadow: 0 4px 16px #ff980044;
    }
    .main-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: stretch;
      justify-content: center;
      background: var(--bonk-bg);
      min-width: 0;
      min-height: 0;
      padding: 0;
      margin: 0;
    }
    .chat-container {
      background: var(--bonk-chat);
      border-radius: 18px;
      box-shadow: var(--bonk-shadow);
      width: 100%;
      max-width: 100vw;
      height: 96vh;
      min-height: 0;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      border: 3px solid var(--bonk-border);
      margin: 0;
      position: relative;
    }
    .chat-header {
      background: var(--bonk-orange);
      color: #fff;
      padding: 18px 32px;
      font-size: 2.1rem;
      font-family: 'Luckiest Guy', cursive;
      font-weight: 700;
      text-align: left;
      letter-spacing: 2px;
      border-bottom: 3px solid var(--bonk-border);
      display: flex;
      align-items: center;
      gap: 18px;
      text-shadow: 2px 2px 0 #ff3d00, 0 2px 8px #fffde7;
      border-radius: 0;
      justify-content: space-between;
    }
    .chat-header .channel-title {
      font-size: 1.4rem;
      font-family: 'Luckiest Guy', cursive;
      font-weight: 500;
      color: #fffde7;
      background: var(--bonk-red);
      border-radius: 10px;
      padding: 6px 18px;
      margin-left: 16px;
      letter-spacing: 1px;
      box-shadow: 0 2px 8px #ff9800;
    }
    .chat-messages {
      flex: 1;
      padding: 24px 32px 12px 32px;
      overflow-y: auto;
      background: var(--bonk-chat);
      display: flex;
      flex-direction: column;
      gap: 12px;
      scroll-behavior: smooth;
    }
    .chat-messages::-webkit-scrollbar {
      width: 10px;
      background: #fffbe6;
    }
    .chat-messages::-webkit-scrollbar-thumb {
      background: var(--bonk-orange);
      border-radius: 8px;
    }
    .message {
      display: flex;
      flex-direction: row;
      align-items: flex-end;
      gap: 10px;
      max-width: 80%;
    }
    .message .avatar {
      width: 38px;
      height: 38px;
      border-radius: 50%;
      background: #fff;
      border: 2px solid var(--bonk-orange);
      object-fit: cover;
      box-shadow: 0 2px 8px #ff9800;
    }
    .message-content {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      background: #fffde7;
      border-radius: 16px 16px 16px 4px;
      padding: 14px 20px;
      box-shadow: 0 2px 8px #ff980044;
      font-size: 1.15rem;
      word-break: break-word;
      position: relative;
      min-width: 80px;
      max-width: 420px;
    }
    .message.me {
      align-self: flex-end;
      flex-direction: row-reverse;
    }
    .message.me .message-content {
      background: var(--bonk-chat-me);
      border-radius: 16px 16px 4px 16px;
      color: #ff3d00;
      box-shadow: 0 2px 8px #ff980044;
    }
    .message.me .avatar {
      border: 2px solid var(--bonk-red);
    }
    .message .meta {
      font-size: 0.9rem;
      color: #ff9800;
      margin-bottom: 4px;
      font-family: 'Roboto', Arial, sans-serif;
      font-weight: 700;
    }
    .chat-input {
      display: flex;
      border-top: 3px solid var(--bonk-border);
      background: var(--bonk-chat);
      padding: 14px 32px;
      gap: 10px;
    }
    .chat-input input {
      flex: 1;
      padding: 16px 18px;
      border: 2px solid var(--bonk-border);
      border-radius: 12px;
      font-size: 1.15rem;
      outline: none;
      background: #fffbe6;
      transition: border 0.2s;
      font-family: 'Roboto', Arial, sans-serif;
    }
    .chat-input input:focus {
      border: 2.5px solid var(--bonk-orange);
    }
    .chat-input button {
      background: var(--bonk-red);
      color: #fff;
      border: none;
      border-radius: 12px;
      padding: 16px 32px;
      font-size: 1.15rem;
      font-family: 'Luckiest Guy', cursive;
      font-weight: 700;
      cursor: pointer;
      transition: background 0.2s;
      box-shadow: 0 2px 8px #ff980044;
    }
    .chat-input button:hover {
      background: var(--bonk-orange);
    }
    .username-modal {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(255, 236, 179, 0.95);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    .username-box {
      background: #fffde7;
      border-radius: 20px;
      box-shadow: 0 4px 24px #ff980044;
      padding: 36px 32px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 22px;
      border: 3px solid var(--bonk-border);
    }
    .username-box input {
      padding: 12px 16px;
      border: 2px solid var(--bonk-border);
      border-radius: 10px;
      font-size: 1.2rem;
      outline: none;
      background: #fffbe6;
      font-family: 'Roboto', Arial, sans-serif;
    }
    .username-box button {
      background: var(--bonk-orange);
      color: #fff;
      border: none;
      border-radius: 10px;
      padding: 12px 24px;
      font-size: 1.1rem;
      font-family: 'Luckiest Guy', cursive;
      font-weight: 700;
      cursor: pointer;
      transition: background 0.2s;
    }
    .username-box button:hover {
      background: var(--bonk-red);
    }
    /* è¡Œæƒ…åŒºå‘å°„å°æ ·å¼ */
    .market-header {
      display: flex;
      align-items: center;
      gap: 18px;
      background: var(--bonk-orange);
      color: #fff;
     font-size: 1.2rem;
      font-family: 'Luckiest Guy', cursive;
     padding: 6px 16px;
      border-bottom: 3px solid var(--bonk-border);
        border-radius: 0;
      box-shadow: 0 2px 8px #ff980044;
           min-height: 38px;
      height: 38px;
    }
    .market-header img {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background: #fffde7;
      border: 3px solid #fffde7;
      object-fit: cover;
      box-shadow: 0 2px 8px #ff9800;
    }
    .launch-btn {
      background: var(--bonk-red);
      color: #fff;
      border: none;
      border-radius: 12px;
      padding: 12px 28px;
      font-size: 1.1rem;
      font-family: 'Luckiest Guy', cursive;
      font-weight: 700;
      cursor: pointer;
      margin-left: auto;
      box-shadow: 0 2px 8px #ff980044;
      transition: background 0.2s;
    }
    .launch-btn:hover {
      background: var(--bonk-orange);
    }
    .market-iframe-box {
      flex: 1;
      display: flex;
      align-items: stretch;
      justify-content: stretch;
      background: #fffbe6;
      border-radius: 0 0 0 0;
      box-shadow: none;
      padding: 0;
            margin: 0;
      height: calc(100% - 38px);
    }
    .market-iframe-box iframe {
      width: 100%;
      height: 100%;
      border: 0;
      overflow: hidden;
         border-radius: 0;
      box-shadow: none;
      background: #fffde7;
      min-height: 0;
    }
    @media (max-width: 900px) {
      .chat-container {
        max-width: 100vw;
        height: 100vh;
        border-radius: 0;
      }
      .sidebar {
        width: 48px;
        min-width: 48px;
      }
      .logo {
        flex-direction: column;
        padding: 18px 0 12px 0;
        font-size: 1.2rem;
      }
      .logo img {
        width: 32px;
        height: 32px;
      }
      .channels {
        padding: 0 4px;
        margin-top: 8px;
      }
      .channel {
        padding: 10px 6px;
        font-size: 1rem;
      }
      .chat-header, .market-header {
        font-size: 1.1rem;
        padding: 10px 8px;
      }
      .chat-messages {
        padding: 8px 4px 4px 4px;
        gap: 6px;
      }
      .chat-input {
        padding: 6px 4px;
        gap: 4px;
      }
      .market-iframe-box iframe {
        min-height: 60vh;
        border-radius: 6px;
      }
    }
    @media (max-width: 600px) {
      .app-container {
        flex-direction: column;
      }
      .sidebar {
        flex-direction: row;
        width: 100vw;
        height: 60px;
        min-width: 0;
        min-height: 60px;
        box-shadow: 0 2px 12px #ff980044;
      }
      .logo {
        padding: 8px 8px 8px 8px;
        font-size: 1rem;
      }
      .channels {
        flex-direction: row;
        gap: 4px;
        margin-top: 0;
        padding: 0 4px;
      }
      .main-content {
        padding: 0;
      }
      .chat-container {
        border-radius: 0;
        height: calc(100vh - 60px);
        min-height: 0;
      }
      .chat-header {
        font-size: 1.2rem;
        padding: 12px 12px;
      }
      .chat-messages {
        padding: 12px 8px 8px 8px;
        gap: 8px;
      }
      .chat-input {
        padding: 8px 8px;
        gap: 4px;
      }
      .market-header {
        font-size: 1.1rem;
        padding: 12px 12px;
      }
      .market-header img {
        width: 28px;
        height: 28px;
      }
    }
    .user-logout-btn {
      margin-top: 6px;
      background: #fff;
      color: var(--bonk-red);
      border: 2px solid var(--bonk-red);
      border-radius: 8px;
      padding: 6px 18px;
      font-size: 1rem;
      font-family: 'Luckiest Guy', cursive;
      font-weight: 700;
      cursor: pointer;
      box-shadow: 0 2px 8px #ff980044;
      transition: background 0.2s, color 0.2s;
    }
    .user-logout-btn:hover {
      background: var(--bonk-red);
      color: #fff;
    }
    .wallet-connect-box {
      position: static;
      margin-left: 16px;
      display: flex;
      flex-direction: row;
      align-items: center;
      gap: 10px;
    }
    .wallet-connect-btn {
      background: linear-gradient(90deg, #ff9800 0%, #ff3d00 100%);
      color: #fff;
      border: none;
      border-radius: 16px;
      padding: 12px 28px;
      font-size: 1.1rem;
      font-family: 'Luckiest Guy', cursive;
      font-weight: 700;
      cursor: pointer;
      box-shadow: 0 2px 12px #ff980088;
      transition: background 0.2s, box-shadow 0.2s;
      outline: none;
    }
    .wallet-connect-btn:hover {
      background: linear-gradient(90deg, #ff3d00 0%, #ff9800 100%);
      box-shadow: 0 4px 16px #ff9800cc;
    }
    .wallet-address {
      background: #fffde7;
      color: #ff3d00;
      border-radius: 12px;
      padding: 8px 18px;
      font-size: 1rem;
      font-family: 'Roboto', Arial, sans-serif;
      font-weight: 700;
      box-shadow: 0 2px 8px #ff980044;
      cursor: pointer;
      user-select: text;
    }
    .contract-room-list-box {
      margin-top: 8px;
    }
    #contract-room-list {
      max-height: 180px;
      overflow-y: auto;
      background: #fffde7;
      border-radius: 8px;
      border: 1px solid #ffe082;
      padding: 4px 0;
    }
    .room-list-item {
      padding: 8px 12px;
      cursor: pointer;
      font-size: 0.98rem;
      color: #ff9800;
      border-bottom: 1px solid #ffe082;
      transition: background 0.15s;
      border-radius: 6px;
      margin: 2px 4px;
    }
    .room-list-item:hover, .room-list-item.active {
      background: #ffe082;
      color: #ff3d00;
    }
    #contract-room-list::-webkit-scrollbar {
      width: 8px;
      background: #fffbe6;
    }
    #contract-room-list::-webkit-scrollbar-thumb {
      background: #ffe082;
      border-radius: 8px;
    }
  </style>
</head>
<body>
  <!-- èƒŒæ™¯è£…é¥° -->
  <svg class="bg-waves" viewBox="0 0 1440 220" fill="none" xmlns="http://www.w3.org/2000/svg">
    <path d="M0 120L60 110C120 100 240 80 360 90C480 100 600 140 720 150C840 160 960 140 1080 120C1200 100 1320 80 1380 70L1440 60V220H1380C1320 220 1200 220 1080 220C960 220 840 220 720 220C600 220 480 220 360 220C240 220 120 220 60 220H0V120Z" fill="#ffe082"/>
    <path d="M0 180L60 170C120 160 240 140 360 150C480 160 600 200 720 210C840 220 960 200 1080 180C1200 160 1320 140 1380 130L1440 120V220H1380C1320 220 1200 220 1080 220C960 220 840 220 720 220C600 220 480 220 360 220C240 220 120 220 60 220H0V180Z" fill="#ff9800" fill-opacity="0.7"/>
  </svg>
  <div class="bg-bubble bg-bubble1"></div>
  <div class="bg-bubble bg-bubble2"></div>
  <div class="bg-bubble bg-bubble3"></div>
  <img class="bg-bonk bg-bonk-right" src="2.jpg" alt="Bonkå³ä¸Šç‹—ç‹—">
  <img class="bg-bonk bg-bonk-left" src="3.jpg" alt="Bonkå·¦ä¸‹ç‹—ç‹—">
  <div class="app-container">
    <aside class="sidebar">
      <div class="sidebar-content">
        <div class="logo">
          <img src="2.jpg" alt="Bonk Logo">
          <span>BONK</span>
        </div>
        <div class="user-avatar-box" id="user-avatar-box" style="display:none">
          <img class="user-avatar-img" id="user-avatar-img" src="" alt="User Avatar">
          <div class="user-avatar-name" id="user-avatar-name"></div>
          <button class="user-logout-btn" id="user-logout-btn">Log Out</button>
          <button class="user-edit-btn" id="user-edit-btn" style="display:none;margin-top:6px;background:#ffe082;color:#ff3d00;border:2px solid #ff9800;border-radius:8px;padding:6px 18px;font-size:1rem;font-family:'Luckiest Guy',cursive;font-weight:700;cursor:pointer;box-shadow:0 2px 8px #ff980044;transition:background 0.2s, color 0.2s;">ç¼–è¾‘èµ„æ–™</button>
        </div>
        <div class="channels">
          <button class="channel active" data-channel="lobby">ğŸ¶ Lobby</button>
          <button class="channel" data-channel="tech">ğŸ’¬ Tech</button>
          <button class="channel" data-channel="market">ğŸš€ Market</button>
        </div>
        <div class="contract-room-list-box" style="padding: 8px 12px 0 12px;">
          <input id="room-search-input" type="text" placeholder="Search channel" style="width: 100%; padding: 6px; border-radius: 6px; border: 1px solid #ccc; margin-bottom: 6px;">
          <div id="contract-room-list" style="max-height: 180px; overflow-y: auto; background: #fffde7; border-radius: 8px; border: 1px solid #ffe082; padding: 4px 0;"></div>
        </div>
        <div id="wallet-connect-box" class="wallet-connect-box" style="margin: 18px 0 0 0; justify-content: center;">
          <button id="wallet-connect-btn" class="wallet-connect-btn">ğŸ”— Connect Wallet</button>
          <div id="wallet-address" class="wallet-address" style="display:none"></div>
        </div>
      </div>
      <div class="sidebar-bottom">
        <img class="sidebar-bonk-img" src="4.jpg" alt="Bonk1">
        <img class="sidebar-bonk-img" src="5.jpg" alt="Bonk2">
        <img class="sidebar-bonk-img" src="6.jpg" alt="Bonk3">
      </div>
    </aside>
    <main class="main-content">
      <div class="chat-container" id="main-content-box">
        <div class="chat-header">
          Bonk Chatroom
          <span class="channel-title" id="current-channel-title">ğŸ¶ Lobby</span>
        </div>
        <div class="chat-messages" id="chat-messages"></div>
        <form class="chat-input" id="chat-form">
          <input type="text" id="message-input" placeholder="Type a message..." autocomplete="off" required />
          <button type="submit">Send</button>
        </form>
      </div>
    </main>
  </div>
  <div class="username-modal" id="username-modal">
    <div class="username-box">
      <h2>Enter your nickname</h2>
      <input type="text" id="username-input" maxlength="16" placeholder="Nickname" required />
      <button id="username-btn">Enter Chatroom</button>
      <button id="twitter-login-btn" style="background:#1da1f2;color:#fff;margin-top:8px;">
        <img src="https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/svg/1f426.svg" style="width:20px;vertical-align:middle;margin-right:6px;">Login with Twitter
      </button>
    </div>
  </div>
  <div class="edit-profile-modal" id="edit-profile-modal" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;z-index:2000;background:rgba(255,236,179,0.95);align-items:center;justify-content:center;">
    <div style="background:#fffde7;border-radius:20px;box-shadow:0 4px 24px #ff980044;padding:36px 32px;display:flex;flex-direction:column;align-items:center;gap:22px;border:3px solid var(--bonk-border);min-width:320px;">
      <h2>ç¼–è¾‘ä¸ªäººèµ„æ–™</h2>
      <label style="width:100%;text-align:left;">ç”¨æˆ·åï¼š<input type="text" id="edit-username-input" maxlength="16" style="width:100%;padding:8px 12px;margin-top:4px;border-radius:8px;border:1px solid #ccc;"></label>
      <label style="width:100%;text-align:left;">å¤´åƒURLï¼š
        <div style="display:flex;align-items:center;gap:8px;">
          <input type="text" id="edit-avatar-input" style="flex:1;padding:8px 12px;margin-top:4px;border-radius:8px;border:1px solid #ccc;">
          <button id="upload-avatar-btn" type="button" style="background:#ffe082;color:#ff3d00;border:1px solid #ff9800;border-radius:6px;padding:6px 12px;font-size:0.95rem;cursor:pointer;">ä¸Šä¼ å›¾ç‰‡</button>
          <input type="file" id="avatar-file-input" accept="image/*" style="display:none;">
        </div>
      </label>
      <label style="width:100%;text-align:left;">å¤´åƒè·³è½¬é“¾æ¥ï¼š<input type="text" id="edit-link-input" style="width:100%;padding:8px 12px;margin-top:4px;border-radius:8px;border:1px solid #ccc;"></label>
      <div style="display:flex;gap:16px;margin-top:12px;">
        <button id="edit-profile-save-btn" style="background:var(--bonk-orange);color:#fff;border:none;border-radius:10px;padding:10px 24px;font-size:1.1rem;font-family:'Luckiest Guy',cursive;font-weight:700;cursor:pointer;">ä¿å­˜</button>
        <button id="edit-profile-cancel-btn" style="background:#fff;color:var(--bonk-red);border:2px solid var(--bonk-red);border-radius:10px;padding:10px 24px;font-size:1.1rem;font-family:'Luckiest Guy',cursive;font-weight:700;cursor:pointer;">å–æ¶ˆ</button>
      </div>
    </div>
  </div>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js";
    import { getDatabase, ref, push, onChildAdded, onChildRemoved, off, remove, get, set, onValue, onChildChanged } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-database.js";
    import { getAuth, signInWithPopup, TwitterAuthProvider, signOut } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-auth.js";
    // Firebase é…ç½®
    const firebaseConfig = {
      apiKey: "AIzaSyA5Z5ieEbAcfQX0kxGSn9ldGXhzvAwx_8M",
      authDomain: "chat-294cc.firebaseapp.com",
      projectId: "chat-294cc",
      storageBucket: "chat-294cc.firebasestorage.app",
      messagingSenderId: "913615304269",
      appId: "1:913615304269:web:a7634789985f09758e4e04",
      measurementId: "G-16E82FDM89",
      databaseURL: "https://chat-294cc-default-rtdb.firebaseio.com/"
    };
    // åˆå§‹åŒ– Firebase
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);
    const provider = new TwitterAuthProvider();

    // Bonkç‹—ç‹—å¤´åƒ
    const bonkAvatar = "2.jpg";

    // é¢‘é“å®šä¹‰
    const channels = [
      { key: 'lobby', name: 'ğŸ¶ Lobby' },
      { key: 'tech', name: 'ğŸ’¬ Tech' },
      { key: 'market', name: 'ğŸš€ Market' }
    ];
    let currentChannel = 'lobby';
    let username = '';
    let messagesRef = null;
    let unsubscribe = null;

    // DOM
    const usernameModal = document.getElementById('username-modal');
    const usernameInput = document.getElementById('username-input');
    const usernameBtn = document.getElementById('username-btn');
    const chatMessages = document.getElementById('chat-messages');
    const chatForm = document.getElementById('chat-form');
    const messageInput = document.getElementById('message-input');
    const channelBtns = document.querySelectorAll('.channel');
    const channelTitle = document.getElementById('current-channel-title');
    const mainContentBox = document.getElementById('main-content-box');

    // å¤´åƒç”Ÿæˆç›¸å…³
    function getOrCreateAvatarSeed() {
      let seed = localStorage.getItem('bonk-avatar-seed');
      if (!seed) {
        seed = Math.random().toString(36).substring(2, 12) + Date.now();
        localStorage.setItem('bonk-avatar-seed', seed);
      }
      return seed;
    }
    function getAvatarUrl(seed) {
      return `https://api.dicebear.com/7.x/pixel-art/svg?seed=${encodeURIComponent(seed)}`;
    }
    function getCurrentAvatarUrl() {
      return localStorage.getItem('chat-avatar') || getAvatarUrl(getOrCreateAvatarSeed());
    }
    function showUserAvatarBox(name, avatarUrl) {
      const box = document.getElementById('user-avatar-box');
      const img = document.getElementById('user-avatar-img');
      const n = document.getElementById('user-avatar-name');
      const seed = getOrCreateAvatarSeed();

      // ç‰¹æ®Šå¤„ç†Tom
      if (name === 'Tom') {
        img.src = 'tom.png';
        n.textContent = name || '';
        box.style.display = 'flex';
        img.style.cursor = 'pointer';
        img.title = 'ç‚¹å‡»è®¿é—®ä¸»é¡µ';
        img.onclick = () => { window.open('https://x.com/SolportTom', '_blank'); };
        updateEditProfileBtnVisibility();
        return;
      }

      img.src = avatarUrl || getAvatarUrl(seed);
      n.textContent = name || '';
      box.style.display = 'flex';
      updateEditProfileBtnVisibility();
      // åªæœ‰ç®¡ç†å‘˜å¤´åƒå¯ç‚¹å‡»è·³è½¬
      if (isAdmin()) {
        let link = localStorage.getItem('chat-custom-profile-link');
        if (!link) link = localStorage.getItem('chat-twitter-profile');
        if (link) {
          img.style.cursor = 'pointer';
          img.title = 'ç‚¹å‡»è®¿é—®ä¸»é¡µ';
          img.onclick = () => { window.open(link, '_blank'); };
        } else {
          img.style.cursor = '';
          img.title = '';
          img.onclick = null;
        }
      } else {
        img.style.cursor = '';
        img.title = '';
        img.onclick = null;
      }
    }

    // è·å–å½“å‰ç”¨æˆ·æ¨ç‰¹ç”¨æˆ·å
    function getCurrentTwitterUsername() {
      return localStorage.getItem('chat-twitter-username') || '';
    }

    // ç®¡ç†å‘˜ Twitter ç”¨æˆ·åç™½åå•
    const ADMIN_TWITTER_USERNAMES = ['Bonk_House_', 'hangnb6666'];
    function isAdmin() {
      return ADMIN_TWITTER_USERNAMES.includes(getCurrentTwitterUsername()) || username === 'god';
    }

    let lastSendTime = 0; // è®°å½•ä¸Šæ¬¡å‘é€æ—¶é—´
    // ç»‘å®šèŠå¤©è¡¨å•å‘é€äº‹ä»¶
    function bindChatFormEvents(chatFormEl, messageInputEl) {
      if (!chatFormEl || !messageInputEl) return;
      chatFormEl.onsubmit = async (e) => {
        e.preventDefault();
        const text = messageInputEl.value.trim();
        if (!text || !username) return;
        // æ£€æŸ¥ç¦è¨€
        const muteSnap = await get(ref(db, `mutedUsers/${username}`));
        if (muteSnap.exists()) {
          const muteInfo = muteSnap.val();
          if (muteInfo.until > Date.now()) {
            alert(`ä½ å·²è¢«ç¦è¨€ï¼Œè§£ç¦æ—¶é—´: ${new Date(muteInfo.until).toLocaleTimeString()}`);
            return;
          }
        }
        const now = Date.now();
        // åˆ¤æ–­æ˜¯å¦ä¸ºTwitterç™»å½•ç”¨æˆ·
        const isTwitterUser = !!getCurrentTwitterUsername();
        const limit = isTwitterUser ? 10000 : 60000; // Twitterç”¨æˆ·10ç§’ï¼ŒåŒ¿åç”¨æˆ·60ç§’
        if (now - lastSendTime < limit) {
          alert(isTwitterUser ? 'You can only send one message every 10 seconds.' : 'Anonymous users can only send one message every 60 seconds.');
          return;
        }
        lastSendTime = now;
        push(ref(db, `channels/${currentChannel}/messages`), {
          username,
          text,
          timestamp: now,
          avatar: getCurrentAvatarUrl(),
          twitterUsername: getCurrentTwitterUsername()
        });
        messageInputEl.value = '';
      };
    }

    // æ˜µç§°è¾“å…¥
    usernameBtn.onclick = () => {
      const value = usernameInput.value.trim();
      if (value) {
        username = value;
        usernameModal.style.display = 'none';
        localStorage.setItem('chat-username', username);
        loadChannel(currentChannel);
        // ç»‘å®šåˆå§‹è¡¨å•äº‹ä»¶
        bindChatFormEvents(chatForm, messageInput);
        showUserAvatarBox(username);
      } else {
        usernameInput.focus();
      }
    };
    window.onload = () => {
      const saved = localStorage.getItem('chat-username');
      if (saved) {
        username = saved;
        usernameModal.style.display = 'none';
        loadChannel(currentChannel);
        // ç»‘å®šåˆå§‹è¡¨å•äº‹ä»¶
        bindChatFormEvents(chatForm, messageInput);
        showUserAvatarBox(username);
      } else {
        usernameModal.style.display = 'flex';
      }
    };

    // é¢‘é“åˆ‡æ¢
    channelBtns.forEach(btn => {
      btn.onclick = () => {
        if (btn.classList.contains('active')) return;
        channelBtns.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        currentChannel = btn.getAttribute('data-channel');
        channelTitle.textContent = btn.textContent;
        if (currentChannel === 'market') {
          // è¡Œæƒ…é¢‘é“ï¼šæ˜¾ç¤ºè¡Œæƒ… iframeï¼Œéšè—èŠå¤©ç›¸å…³
          mainContentBox.innerHTML = `
            <div class="market-header">
              <img src="${bonkAvatar}" alt="Bonk Logo">
              letsbonk Launchpad
              <button class="launch-btn" onclick="window.open('https://t.co/aSsQXTq8vN')">Launch ğŸš€</button>
            </div>
            <div class="market-iframe-box">
              <iframe src="https://dexscreener.com/solana/DezXAZ8z7PnrnRJjz3wXBoRgixCa6xjnB7YaB1pPB263?embed=1&theme=light" allowfullscreen></iframe>
            </div>
          `;
        } else {
          // èŠå¤©é¢‘é“ï¼šæ¢å¤èŠå¤©ç•Œé¢
          mainContentBox.innerHTML = `
            <div class="chat-header">
              Bonk Chatroom
              <span class="channel-title" id="current-channel-title">${btn.textContent}</span>
            </div>
            <div class="chat-messages" id="chat-messages"></div>
            <form class="chat-input" id="chat-form">
              <input type="text" id="message-input" placeholder="Type a message..." autocomplete="off" required />
              <button type="submit">Send</button>
            </form>
          `;
          // é‡æ–°ç»‘å®š DOM
          setTimeout(() => {
            const chatMessagesNew = document.getElementById('chat-messages');
            const chatFormNew = document.getElementById('chat-form');
            const messageInputNew = document.getElementById('message-input');
            // é‡æ–°ç›‘å¬æ¶ˆæ¯
            loadChannel(currentChannel, chatMessagesNew);
            // ç»‘å®šå‘é€
            bindChatFormEvents(chatFormNew, messageInputNew);
          }, 0);
        }
      };
    });

    // åŠ è½½é¢‘é“æ¶ˆæ¯
    function loadChannel(channelKey, chatMessagesBox = chatMessages) {
      if (unsubscribe) unsubscribe();
      if (messagesRef) off(messagesRef);
      if (channelKey === 'market') return;
      messagesRef = ref(db, `channels/${channelKey}/messages`);
      chatMessagesBox.innerHTML = '';
      onChildAdded(messagesRef, (snapshot) => {
        const msg = snapshot.val();
        addMessage(
          msg.username,
          msg.text,
          msg.timestamp,
          chatMessagesBox,
          snapshot.key,
          msg.avatar,
          msg.twitterUsername,
          msg.deleted
        );
      });
      // æ–°å¢ï¼šç›‘å¬æ¶ˆæ¯å˜æ›´ï¼ˆå¦‚ç®¡ç†å‘˜æ’¤å›ï¼‰
      onChildChanged(messagesRef, (snapshot) => {
        const msg = snapshot.val();
        const msgId = snapshot.key;
        // æ‰¾åˆ°é¡µé¢ä¸Šå¯¹åº”çš„æ¶ˆæ¯èŠ‚ç‚¹ï¼Œç§»é™¤åé‡æ–°æ¸²æŸ“
        const msgDiv = chatMessagesBox.querySelector(`.message[data-id='${msgId}']`);
        if (msgDiv) msgDiv.remove();
        addMessage(
          msg.username,
          msg.text,
          msg.timestamp,
          chatMessagesBox,
          msgId,
          msg.avatar,
          msg.twitterUsername,
          msg.deleted
        );
      });
      // æ’¤å›ç›‘å¬
      onChildRemoved(messagesRef, (snapshot) => {
        const msgId = snapshot.key;
        const msgDiv = chatMessagesBox.querySelector(`.message[data-id='${msgId}']`);
        if (msgDiv) msgDiv.remove();
      });
      setTimeout(() => {
        chatMessagesBox.scrollTop = chatMessagesBox.scrollHeight;
      }, 100);
    }

    // æ·»åŠ æ¶ˆæ¯åˆ°é¡µé¢
    function addMessage(user, text, timestamp, chatMessagesBox = chatMessages, msgId = '', avatarUrl = '', twitterUsername = '', deleted = false) {
      const msgDiv = document.createElement('div');
      msgDiv.className = 'message' + (user === username ? ' me' : '');
      if (msgId) msgDiv.setAttribute('data-id', msgId);
      // ç”¨æˆ·å¤´åƒ
      let avatarSrc = avatarUrl;
      if (user === 'Tom') {
        avatarSrc = 'tom.png';
      } else if (!avatarSrc) {
        if (user === username) {
          avatarSrc = getCurrentAvatarUrl();
        } else {
          avatarSrc = getAvatarUrl(user);
        }
      }
      // åªè¦æœ‰twitterUsernameå°±å¯ç‚¹å‡»
      let twitterProfileUrl = '';
      if (user === 'Tom') {
        twitterProfileUrl = 'https://x.com/SolportTom';
      } else if (twitterUsername) {
        twitterProfileUrl = `https://twitter.com/${twitterUsername}`;
      }
      const avatar = document.createElement('img');
      avatar.className = 'avatar';
      avatar.src = avatarSrc;
      avatar.alt = 'avatar';
      if (twitterProfileUrl) {
        avatar.style.cursor = 'pointer';
        avatar.title = 'Visit Profile';
        avatar.onclick = (e) => {
          e.stopPropagation();
          window.open(twitterProfileUrl, '_blank');
        };
      }
      // å†…å®¹
      const contentDiv = document.createElement('div');
      contentDiv.className = 'message-content';
      const meta = document.createElement('div');
      meta.className = 'meta';
      meta.textContent = `${user} Â· ${formatTime(timestamp)}`;
      contentDiv.appendChild(meta);
      // å¦‚æœè¢«ç®¡ç†å‘˜æ’¤å›ï¼Œæ˜¾ç¤ºè¿è§„æç¤ºï¼Œå¦åˆ™æ˜¾ç¤ºå†…å®¹
      if (deleted) {
        contentDiv.appendChild(document.createTextNode('æ­¤å†…å®¹è¿è§„å·²è¢«åˆ é™¤'));
      } else {
        contentDiv.appendChild(document.createTextNode(text));
      }
      // æ’¤å›æŒ‰é’®ï¼ˆæœ¬äººæˆ–ç®¡ç†å‘˜ï¼‰ï¼Œå³ä½¿è¢«æ ‡è®°è¿è§„ä¹Ÿèƒ½æ’¤å›
      if ((user === username || isAdmin()) && msgId) {
        const revokeBtn = document.createElement('button');
        revokeBtn.textContent = 'Revoke';
        revokeBtn.title = 'Revoke this message';
        revokeBtn.style.cssText = 'position:absolute;top:8px;right:10px;background:#fff3e0;color:#ff3d00;border:1px solid #ff9800;border-radius:6px;padding:2px 10px;font-size:0.9rem;cursor:pointer;z-index:2;';
        revokeBtn.onclick = async () => {
          if (user === username) {
            // æœ¬äººæ’¤å›ï¼Œç›´æ¥åˆ é™¤
            await remove(ref(db, `channels/${currentChannel}/messages/${msgId}`));
          } else if (isAdmin()) {
            // ç®¡ç†å‘˜æ’¤å›ï¼Œæ›¿æ¢ä¸ºè¿è§„æç¤º
            await set(ref(db, `channels/${currentChannel}/messages/${msgId}`), {
              username: user,
              text: '',
              timestamp,
              avatar: avatarUrl,
              twitterUsername: twitterUsername,
              deleted: true
            });
          }
        };
        contentDiv.style.position = 'relative';
        contentDiv.appendChild(revokeBtn);
      }
      // ç®¡ç†å‘˜ç¦è¨€æŒ‰é’®
      if (isAdmin() && user !== username && msgId) {
        const muteBtn = document.createElement('button');
        muteBtn.textContent = 'ç¦è¨€';
        muteBtn.title = 'ç¦è¨€è¯¥ç”¨æˆ·';
        muteBtn.style.cssText = 'position:absolute;top:8px;right:80px;background:#ffe082;color:#ff3d00;border:1px solid #ff9800;border-radius:6px;padding:2px 10px;font-size:0.9rem;cursor:pointer;z-index:2;';
        muteBtn.onclick = async () => {
          const option = window.prompt('ç¦è¨€æ—¶é•¿: 5 = äº”åˆ†é’Ÿ, 0 = æ°¸ä¹…', '5');
          if (option === null) return;
          let until = 0;
          if (option === '0') {
            until = Date.now() + 100 * 365 * 24 * 60 * 60 * 1000; // 100å¹´
          } else {
            until = Date.now() + parseInt(option) * 60 * 1000;
          }
          await set(ref(db, `mutedUsers/${user}`), { until, by: username });
          alert(`${user} å·²è¢«ç¦è¨€${option === '0' ? 'æ°¸ä¹…' : option + 'åˆ†é’Ÿ'}`);
        };
        contentDiv.style.position = 'relative';
        contentDiv.appendChild(muteBtn);
        // è§£é™¤ç¦è¨€æŒ‰é’®
        // æ£€æŸ¥è¯¥ç”¨æˆ·æ˜¯å¦è¢«ç¦è¨€
        get(ref(db, `mutedUsers/${user}`)).then((snap) => {
          if (snap.exists()) {
            const unmuteBtn = document.createElement('button');
            unmuteBtn.textContent = 'è§£é™¤ç¦è¨€';
            unmuteBtn.title = 'è§£é™¤è¯¥ç”¨æˆ·ç¦è¨€';
            unmuteBtn.style.cssText = 'position:absolute;top:8px;right:160px;background:#fffde7;color:#ff3d00;border:1px solid #ff9800;border-radius:6px;padding:2px 10px;font-size:0.9rem;cursor:pointer;z-index:2;';
            unmuteBtn.onclick = async () => {
              await remove(ref(db, `mutedUsers/${user}`));
              alert(`${user} å·²è§£é™¤ç¦è¨€`);
            };
            contentDiv.appendChild(unmuteBtn);
          }
        });
      }
      msgDiv.appendChild(avatar);
      msgDiv.appendChild(contentDiv);
      chatMessagesBox.appendChild(msgDiv);
      chatMessagesBox.scrollTop = chatMessagesBox.scrollHeight;
    }
    // æ—¶é—´æ ¼å¼åŒ–
    function formatTime(ts) {
      const date = new Date(ts);
      return `${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;
    }

    // ç™»å½•æŒ‰é’®äº‹ä»¶
    document.getElementById('twitter-login-btn').onclick = async () => {
      try {
        const result = await signInWithPopup(auth, provider);
        const user = result.user;
        // user.displayName, user.photoURL, user.uid
        localStorage.setItem('chat-username', user.displayName);
        localStorage.setItem('chat-avatar', user.photoURL);
        // ä¿å­˜æ¨ç‰¹ä¸»é¡µé“¾æ¥å’Œç”¨æˆ·å
        let twitterProfile = '';
        let twitterUsername = '';
        if (user.reloadUserInfo && user.reloadUserInfo.screenName) {
          twitterUsername = user.reloadUserInfo.screenName;
          twitterProfile = `https://twitter.com/${twitterUsername}`;
        } else if (user.providerData && user.providerData[0] && user.providerData[0].screenName) {
          twitterUsername = user.providerData[0].screenName;
          twitterProfile = `https://twitter.com/${twitterUsername}`;
        }
        if (twitterProfile && twitterUsername) {
          localStorage.setItem('chat-twitter-profile', twitterProfile);
          localStorage.setItem('chat-twitter-username', twitterUsername);
        } else {
          localStorage.removeItem('chat-twitter-profile');
          localStorage.removeItem('chat-twitter-username');
        }
        showUserAvatarBox(user.displayName, user.photoURL);
        username = user.displayName;
        usernameModal.style.display = 'none';
        loadChannel(currentChannel);
        bindChatFormEvents(chatForm, messageInput);
      } catch (error) {
        alert('Twitter login failed: ' + error.message);
      }
    };

    // é€€å‡ºç™»å½•é€»è¾‘
    document.getElementById('user-logout-btn').onclick = async () => {
      // æ¸…é™¤æœ¬åœ°å­˜å‚¨
      localStorage.removeItem('chat-username');
      localStorage.removeItem('chat-avatar');
      localStorage.removeItem('bonk-avatar-seed');
      // Firebase signOutï¼ˆå¦‚æœæ˜¯æ¨ç‰¹ç™»å½•ï¼‰
      try {
        await signOut(auth);
      } catch (e) {}
      // éšè—å¤´åƒåŒºï¼Œå¼¹å‡ºç™»å½•å¼¹çª—
      document.getElementById('user-avatar-box').style.display = 'none';
      username = '';
      usernameModal.style.display = 'flex';
    };

    // é’±åŒ…è¿æ¥ï¼ˆåªæ”¯æŒ Phantomï¼‰+ SPL ä»£å¸ä½™é¢æ˜¾ç¤º
    const walletBtn = document.getElementById('wallet-connect-btn');
    const walletAddrDiv = document.getElementById('wallet-address');
    let currentWallet = null;
    let currentBalance = null;

    // ç›®æ ‡ä»£å¸åˆçº¦åœ°å€
    const TOKEN_MINT = 'DezXAZ8z7PnrnRJjz3wXBoRgixCa6xjnB7YaB1pPB263';

    // è·å– SPL ä»£å¸ä½™é¢
    async function fetchTokenBalance(userAddress) {
      if (!window.solanaWeb3) {
        alert('Solana web3.js library not loaded. Please check your <script> tag for @solana/web3.js!');
        return 0;
      }
      const connection = new window.solanaWeb3.Connection('https://solana-mainnet.g.alchemy.com/v2/qdb04ZyNT_ENXooqO8rN8');
      const owner = new window.solanaWeb3.PublicKey(userAddress);
      const mint = new window.solanaWeb3.PublicKey(TOKEN_MINT);
      const tokenAccounts = await connection.getParsedTokenAccountsByOwner(owner, { mint });
      let amount = 0;
      if (tokenAccounts.value.length > 0) {
        amount = tokenAccounts.value[0].account.data.parsed.info.tokenAmount.uiAmount;
      }
      return amount;
    }

    function shortAddr(addr) {
      if (!addr || addr.length < 8) return addr;
      return addr.slice(0, 4) + '...' + addr.slice(-4);
    }

    async function updateWalletDisplay() {
      let display = shortAddr(currentWallet);
      if (currentBalance !== null) {
        display += ` | ä½™é¢: ${currentBalance}`;
      }
      walletBtn.textContent = display ? display : 'ğŸ”— Connect Wallet';
      walletAddrDiv.style.display = 'none';
      walletBtn.title = currentWallet || '';
    }

    walletBtn.onclick = async () => {
      if (window.solana && window.solana.isPhantom) {
        try {
          const resp = await window.solana.connect();
          currentWallet = resp.publicKey.toString();
          currentBalance = await fetchTokenBalance(currentWallet);
          await updateWalletDisplay();
        } catch (e) {}
      } else {
        alert('Please install Phantom Wallet');
        window.open('https://phantom.app/', '_blank');
      }
    };

    // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æµ‹å·²è¿æ¥é’±åŒ…
    document.addEventListener('DOMContentLoaded', async () => {
      if (window.solana && window.solana.isPhantom && window.solana.isConnected && window.solana.publicKey) {
        currentWallet = window.solana.publicKey.toString();
        currentBalance = await fetchTokenBalance(currentWallet);
        await updateWalletDisplay();
      }
    });

    // åˆçº¦é¢‘é“æœç´¢/åˆ›å»ºé€»è¾‘
    const roomListBox = document.getElementById('contract-room-list');
    const roomSearchInput = document.getElementById('room-search-input');
    let allRooms = [];
    function renderRoomList(filter = '') {
      roomListBox.innerHTML = '';
      // åˆ›å»ºé¢‘é“æŒ‰é’®
      const createBtn = document.createElement('button');
      createBtn.textContent = '+ Create Channel';
      createBtn.style = 'width:96%;margin:4px 2%;padding:7px 0;border-radius:7px;background:var(--bonk-orange);color:#fff;font-weight:bold;border:none;cursor:pointer;';
      createBtn.onclick = createChannelByPrompt;
      roomListBox.appendChild(createBtn);
      const filtered = allRooms.filter(addr => addr.toLowerCase().includes(filter.toLowerCase()));
      if (filtered.length === 0) {
        const emptyDiv = document.createElement('div');
        emptyDiv.style = 'color:#bbb;padding:8px;text-align:center;';
        emptyDiv.textContent = 'No matching channel';
        roomListBox.appendChild(emptyDiv);
        return;
      }
      filtered.forEach(addr => {
        const div = document.createElement('div');
        div.className = 'room-list-item' + (currentChannel === addr ? ' active' : '');
        div.textContent = shortAddr(addr);
        div.title = addr;
        div.onclick = () => {
          // åˆ‡æ¢åˆ°è¯¥é¢‘é“
          currentChannel = addr;
          channelBtns.forEach(b => b.classList.remove('active'));
          channelTitle.textContent = addr;
          mainContentBox.innerHTML = `
            <div class=\"chat-header\">\n              Bonk Chatroom\n              <span class=\"channel-title\" id=\"current-channel-title\">${addr}</span>\n              <div id=\"wallet-connect-box\" class=\"wallet-connect-box\">\n                <button id=\"wallet-connect-btn\" class=\"wallet-connect-btn\">ğŸ”— Connect Wallet</button>\n                <div id=\"wallet-address\" class=\"wallet-address\" style=\"display:none\"></div>\n              </div>\n            </div>\n            <div class=\"chat-messages\" id=\"chat-messages\"></div>\n            <form class=\"chat-input\" id=\"chat-form\">\n              <input type=\"text\" id=\"message-input\" placeholder=\"Type a message...\" autocomplete=\"off\" required />\n              <button type=\"submit\">Send</button>\n            </form>\n          `;
          setTimeout(() => {
            const chatMessagesNew = document.getElementById('chat-messages');
            const chatFormNew = document.getElementById('chat-form');
            const messageInputNew = document.getElementById('message-input');
            loadChannel(currentChannel, chatMessagesNew);
            bindChatFormEvents(chatFormNew, messageInputNew);
          }, 0);
        };
        roomListBox.appendChild(div);
      });
    }
    onValue(ref(db, 'channels'), (snapshot) => {
      console.log('é¢‘é“ç›‘å¬è§¦å‘', snapshot.val());
      if (snapshot.exists()) {
        allRooms = Object.keys(snapshot.val());
        renderRoomList(roomSearchInput.value);
      } else {
        allRooms = [];
        renderRoomList(roomSearchInput.value);
      }
    });
    roomSearchInput.addEventListener('input', () => {
      renderRoomList(roomSearchInput.value);
    });

    // é¢‘é“åˆ›å»ºå…¥å£ï¼šç”¨å¼¹çª—æ–¹å¼
    async function createChannelByPrompt() {
      // æ£€æŸ¥æ˜¯å¦å·²è¿æ¥é’±åŒ…
      if (!currentWallet) {
        alert('Please connect your wallet before creating a channel.');
        return;
      }
      // æ£€æŸ¥ä»£å¸ä½™é¢
      if (typeof fetchTokenBalance === 'function') {
        const balance = await fetchTokenBalance(currentWallet);
        if (balance < 100) {
          alert('You need to hold at least 100 tokens to create a channel.');
          return;
        }
      }
      // è‡ªå®šä¹‰å¼¹çª—ï¼Œå¸¦æç¤º
      const tip = 'A channel must have at least one message to be searchable.';
      const input = window.prompt(`${tip}\n\nPlease enter the contract address (must end with bonk)`);
      const contractAddr = input;
      if (!contractAddr) return;
      if (!contractAddr.toLowerCase().endsWith('bonk')) {
        alert('Only contracts issued on letsbonk can be used to create a channel.');
        return;
      }
      const channelRef = ref(db, `channels/${contractAddr}`);
      const snapshot = await get(channelRef);
      if (snapshot.exists()) {
        alert('Channel already exists.');
        return;
      }
      await set(channelRef, { messages: {} });
      alert('Channel created successfully.');
      // è‡ªåŠ¨åˆ‡æ¢åˆ°æ–°é¢‘é“å¹¶æ¸…ç©ºæœç´¢æ¡†
      roomSearchInput.value = '';
      currentChannel = contractAddr;
      channelBtns.forEach(b => b.classList.remove('active'));
      channelTitle.textContent = contractAddr;
      mainContentBox.innerHTML = `
        <div class=\"chat-header\">\n          Bonk Chatroom\n          <span class=\"channel-title\" id=\"current-channel-title\">${contractAddr}</span>\n          <div id=\"wallet-connect-box\" class=\"wallet-connect-box\">\n            <button id=\"wallet-connect-btn\" class=\"wallet-connect-btn\">ğŸ”— Connect Wallet</button>\n            <div id=\"wallet-address\" class=\"wallet-address\" style=\"display:none\"></div>\n          </div>\n        </div>\n        <div class=\"chat-messages\" id=\"chat-messages\"></div>\n        <form class=\"chat-input\" id=\"chat-form\">\n          <input type=\"text\" id=\"message-input\" placeholder=\"Type a message...\" autocomplete=\"off\" required />\n          <button type=\"submit\">Send</button>\n        </form>\n      `;
      setTimeout(() => {
        const chatMessagesNew = document.getElementById('chat-messages');
        const chatFormNew = document.getElementById('chat-form');
        const messageInputNew = document.getElementById('message-input');
        loadChannel(currentChannel, chatMessagesNew);
        bindChatFormEvents(chatFormNew, messageInputNew);
      }, 0);
    }

    // ç¼–è¾‘èµ„æ–™æŒ‰é’®æ˜¾ç¤ºé€»è¾‘
    function updateEditProfileBtnVisibility() {
      const editBtn = document.getElementById('user-edit-btn');
      if (isAdmin()) {
        editBtn.style.display = '';
      } else {
        editBtn.style.display = 'none';
      }
    }

    // ç¼–è¾‘èµ„æ–™å¼¹çª—é€»è¾‘
    const editProfileModal = document.getElementById('edit-profile-modal');
    const editBtn = document.getElementById('user-edit-btn');
    const editUsernameInput = document.getElementById('edit-username-input');
    const editAvatarInput = document.getElementById('edit-avatar-input');
    const editLinkInput = document.getElementById('edit-link-input');
    const editSaveBtn = document.getElementById('edit-profile-save-btn');
    const editCancelBtn = document.getElementById('edit-profile-cancel-btn');
    const uploadAvatarBtn = document.getElementById('upload-avatar-btn');
    const avatarFileInput = document.getElementById('avatar-file-input');
    // æ‰“å¼€å¼¹çª—
    editBtn.onclick = () => {
      editProfileModal.style.display = 'flex';
      editUsernameInput.value = localStorage.getItem('chat-username') || '';
      editAvatarInput.value = localStorage.getItem('chat-avatar') || '';
      editLinkInput.value = localStorage.getItem('chat-custom-profile-link') || localStorage.getItem('chat-twitter-profile') || '';
    };
    // å–æ¶ˆ
    editCancelBtn.onclick = () => {
      editProfileModal.style.display = 'none';
    };
    // ä¿å­˜
    editSaveBtn.onclick = () => {
      const newName = editUsernameInput.value.trim();
      const newAvatar = editAvatarInput.value.trim();
      const newLink = editLinkInput.value.trim();
      if (!newName) {
        alert('ç”¨æˆ·åä¸èƒ½ä¸ºç©º');
        return;
      }
      localStorage.setItem('chat-username', newName);
      localStorage.setItem('chat-avatar', newAvatar);
      localStorage.setItem('chat-custom-profile-link', newLink);
      username = newName;
      showUserAvatarBox(newName, newAvatar);
      editProfileModal.style.display = 'none';
      loadChannel(currentChannel);
    };
    // ä¸Šä¼ å›¾ç‰‡æŒ‰é’®é€»è¾‘
    uploadAvatarBtn.onclick = () => {
      avatarFileInput.click();
    };
    avatarFileInput.onchange = function() {
      const file = this.files[0];
      if (!file) return;
      if (!file.type.startsWith('image/')) {
        alert('è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶');
        return;
      }
      const reader = new FileReader();
      reader.onload = function(e) {
        editAvatarInput.value = e.target.result;
      };
      reader.readAsDataURL(file);
    };
  </script>
</body>
</html>
