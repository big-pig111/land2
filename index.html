<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>WebRTC + Firebase 直播 Demo</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 0; background: #f5f5f5; }
    #container { max-width: 700px; margin: 30px auto; background: #fff; padding: 24px; border-radius: 8px; box-shadow: 0 2px 8px #0001; }
    video { width: 100%; max-height: 320px; background: #222; margin-bottom: 10px; }
    #chat { height: 180px; overflow-y: auto; border: 1px solid #ddd; padding: 8px; background: #fafafa; margin-bottom: 8px; }
    #msg { width: 80%; }
    #send { width: 18%; }
    .row { margin-bottom: 12px; }
    .me { color: #1976d2; }
    .sys { color: #888; font-style: italic; }
  </style>
</head>
<body>
<div id="container">
  <h2>WebRTC + Firebase 直播 Demo（单一直播间）</h2>
  <div id="auth" class="row">
    <button id="login">匿名登录</button>
    <span id="user"></span>
  </div>
  <div id="room" class="row" style="display:none;">
    <button id="startLive">开始直播（第一个进入者）</button>
  </div>
  <div id="live" class="row" style="display:none;">
    <video id="localVideo" autoplay muted playsinline></video>
    <video id="remoteVideo" autoplay playsinline></video>
    <div id="status"></div>
    <button id="hangup">结束/离开</button>
  </div>
  <div id="chatbox" class="row" style="display:none;">
    <div id="chat"></div>
    <input id="msg" placeholder="输入消息..." />
    <button id="send">发送</button>
  </div>
</div>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script>
// ====== 1. Firebase 配置（请替换为你自己的配置） =====
const firebaseConfig = {
  apiKey: "AIzaSyCUQFtyMIuCN_xEJhK81iAqiq1yf1SCKGo",
  authDomain: "live-damo.firebaseapp.com",
  projectId: "live-damo",
  storageBucket: "live-damo.appspot.com",
  messagingSenderId: "202717835129",
  appId: "1:202717835129:web:b09623c33f6596810dc9a8"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

// ====== 2. 全局变量 =====
let user = null;
let roomId = 'mainlive'; // 固定房间号
let isHost = false;
let pc = null;
let localStream = null;
let chatUnsub = null;
let signalUnsub = null;

// ====== 3. DOM 元素 =====
const loginBtn = document.getElementById('login');
const userSpan = document.getElementById('user');
const roomDiv = document.getElementById('room');
const liveDiv = document.getElementById('live');
const localVideo = document.getElementById('localVideo');
const remoteVideo = document.getElementById('remoteVideo');
const statusDiv = document.getElementById('status');
const hangupBtn = document.getElementById('hangup');
const chatboxDiv = document.getElementById('chatbox');
const chatDiv = document.getElementById('chat');
const msgInput = document.getElementById('msg');
const sendBtn = document.getElementById('send');
const startLiveBtn = document.getElementById('startLive');

// ====== 4. 登录逻辑 =====
loginBtn.onclick = async () => {
  await auth.signInAnonymously();
};
auth.onAuthStateChanged(u => {
  if (u) {
    user = u;
    userSpan.textContent = `已登录: ${u.uid}`;
    loginBtn.style.display = 'none';
    // 检查房间是否存在，动态调整按钮文案
    db.collection('rooms').doc(roomId).get().then(roomDoc => {
      startLiveBtn.disabled = true;
      if (!roomDoc.exists) {
        startLiveBtn.textContent = '开始直播（第一个进入者）';
      } else {
        startLiveBtn.textContent = '观看直播';
      }
      roomDiv.style.display = '';
      startLiveBtn.scrollIntoView({behavior: 'smooth', block: 'center'});
      setTimeout(() => { startLiveBtn.disabled = false; }, 200);
    });
  }
});

// ====== 5. 创建/加入房间 =====
startLiveBtn.onclick = async () => {
  // 检查房间是否存在，决定身份
  const roomDoc = await db.collection('rooms').doc(roomId).get();
  if (!roomDoc.exists) {
    isHost = true;
    await startLive();
    listenChat();
  } else {
    isHost = false;
    await startLive();
    listenChat();
  }
  // 进入后禁用按钮，防止重复点击
  startLiveBtn.disabled = true;
};

// ====== 6. WebRTC 相关 =====
const rtcConfig = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] };
async function startLive() {
  roomDiv.style.display = 'none';
  liveDiv.style.display = '';
  chatboxDiv.style.display = '';
  statusDiv.textContent = isHost ? '你是主播，正在推流（仅第一个进入者可开播）' : '你是观众，正在观看直播';
  pc = new RTCPeerConnection(rtcConfig);
  pc.onicecandidate = e => {
    if (e.candidate) sendSignal({ type: 'candidate', candidate: e.candidate });
  };
  pc.ontrack = e => {
    remoteVideo.srcObject = e.streams[0];
  };
  if (isHost) {
    localVideo.style.display = '';
    localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
    localVideo.srcObject = localStream;
    localStream.getTracks().forEach(track => pc.addTrack(track, localStream));
    const offer = await pc.createOffer();
    await pc.setLocalDescription(offer);
    await db.collection('rooms').doc(roomId).set({ offer: offer, created: Date.now() });
    listenSignal();
  } else {
    localVideo.style.display = 'none';
    const roomDoc = await db.collection('rooms').doc(roomId).get();
    if (!roomDoc.exists) return alert('房间不存在');
    const offer = roomDoc.data().offer;
    await pc.setRemoteDescription(new RTCSessionDescription(offer));
    const answer = await pc.createAnswer();
    await pc.setLocalDescription(answer);
    await db.collection('rooms').doc(roomId).update({ answer: answer });
    listenSignal();
  }
}
function listenSignal() {
  signalUnsub = db.collection('rooms').doc(roomId).onSnapshot(async doc => {
    const data = doc.data();
    if (!data) {
      // 房间被删除，观众端刷新按钮文案
      alert('主播已结束直播');
      startLiveBtn.disabled = false;
      startLiveBtn.textContent = '开始直播（第一个进入者）';
      liveDiv.style.display = 'none';
      chatboxDiv.style.display = 'none';
      roomDiv.style.display = '';
      localVideo.style.display = '';
      localVideo.srcObject = null;
      remoteVideo.srcObject = null;
      if (localStream) {
        localStream.getTracks().forEach(track => track.stop());
        localStream = null;
      }
      startLiveBtn.scrollIntoView({behavior: 'smooth', block: 'center'});
      return;
    }
    if (!isHost && data.answer && !pc.currentRemoteDescription) {
      await pc.setRemoteDescription(new RTCSessionDescription(data.answer));
    }
  });
  db.collection('rooms').doc(roomId).collection('candidates').onSnapshot(snapshot => {
    snapshot.docChanges().forEach(change => {
      if (change.type === 'added') {
        const c = change.doc.data();
        if (c.uid !== user.uid) {
          pc.addIceCandidate(new RTCIceCandidate(c.candidate));
        }
      }
    });
  });
}
async function sendSignal(data) {
  if (data.type === 'candidate') {
    await db.collection('rooms').doc(roomId).collection('candidates').add({
      candidate: data.candidate,
      uid: user.uid
    });
  }
}
hangupBtn.onclick = async () => {
  if (pc) pc.close();
  if (signalUnsub) signalUnsub();
  liveDiv.style.display = 'none';
  chatboxDiv.style.display = 'none';
  roomDiv.style.display = '';
  localVideo.style.display = '';
  localVideo.srcObject = null;
  remoteVideo.srcObject = null;
  if (localStream) {
    localStream.getTracks().forEach(track => track.stop());
    localStream = null;
  }
  if (isHost) {
    await db.collection('rooms').doc(roomId).delete();
  }
  setTimeout(async () => {
    startLiveBtn.disabled = false;
    const roomDoc = await db.collection('rooms').doc(roomId).get();
    if (!roomDoc.exists) {
      startLiveBtn.textContent = '开始直播（第一个进入者）';
    } else {
      startLiveBtn.textContent = '观看直播';
    }
    startLiveBtn.scrollIntoView({behavior: 'smooth', block: 'center'});
  }, 200);
};

// ====== 7. 聊天室 =====
function appendMsg(msg, cls = '') {
  const div = document.createElement('div');
  div.textContent = msg;
  if (cls) div.className = cls;
  chatDiv.appendChild(div);
  chatDiv.scrollTop = chatDiv.scrollHeight;
}
function listenChat() {
  if (chatUnsub) chatUnsub();
  chatDiv.innerHTML = '';
  chatUnsub = db.collection('rooms').doc(roomId).collection('chat')
    .orderBy('ts').onSnapshot(snapshot => {
      snapshot.docChanges().forEach(change => {
        if (change.type === 'added') {
          const d = change.doc.data();
          appendMsg(`${d.uid === user.uid ? '我' : d.uid}: ${d.text}`, d.uid === user.uid ? 'me' : '');
        }
      });
    });
}
sendBtn.onclick = async () => {
  const text = msgInput.value.trim();
  if (!text) return;
  await db.collection('rooms').doc(roomId).collection('chat').add({
    uid: user.uid,
    text,
    ts: Date.now()
  });
  msgInput.value = '';
};
</script>
</body>
</html>
